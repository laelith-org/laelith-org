{{ define "main" }}
<article class="page-content">
  <h1 class="page-title">
    {{ .Title }}
    {{ if .Params.show_copy_button }}
    <button id="copy-text-btn" class="copy-text-button" title="{{ if eq .Language.Lang "fr" }}Copier le texte{{ else }}Copy text{{ end }}">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
        <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
      </svg>
      <span class="copy-text-label">{{ if eq .Language.Lang "fr" }}Copier{{ else }}Copy{{ end }}</span>
    </button>
    {{ end }}
  </h1>
  <div class="page-body" id="page-body-content">
    {{ .Content }}
  </div>
</article>

{{ if .Params.show_copy_button }}
<script>
document.getElementById('copy-text-btn').addEventListener('click', function() {
  const pageTitle = document.querySelector('.page-title');
  const content = document.getElementById('page-body-content');

  // Function to extract formatted text
  function extractFormattedText(element) {
    let result = '';

    function processNode(node, depth = 0) {
      if (node.nodeType === Node.TEXT_NODE) {
        const text = node.textContent.trim();
        if (text) {
          result += text;
        }
      } else if (node.nodeType === Node.ELEMENT_NODE) {
        const tagName = node.tagName.toLowerCase();

        // Add blank line before h2 and h3
        if (tagName === 'h2' || tagName === 'h3') {
          if (result && !result.endsWith('\n\n')) {
            result += '\n\n';
          }
        }

        // Process list items
        if (tagName === 'li') {
          // Add newline if not at start
          if (result && !result.endsWith('\n')) {
            result += '\n';
          }
          result += '- ';
        }

        // Process children
        for (let child of node.childNodes) {
          processNode(child, depth + 1);
        }

        // Add newlines after block elements
        if (['p', 'h1', 'h2', 'h3', 'h4', 'h5', 'h6', 'li', 'div', 'ul', 'ol', 'blockquote', 'hr'].includes(tagName)) {
          if (result && !result.endsWith('\n')) {
            result += '\n';
          }
        }
      }
    }

    processNode(element);

    // Clean up: remove excessive blank lines (more than 2 consecutive newlines)
    result = result.replace(/\n{3,}/g, '\n\n');

    return result.trim();
  }

  // Get the page title text (excluding the button)
  let titleText = '';
  for (let child of pageTitle.childNodes) {
    if (child.nodeType === Node.TEXT_NODE) {
      titleText += child.textContent.trim();
    }
  }

  // Combine title and content
  let text = titleText.trim();
  if (text) {
    text += '\n\n';
  }
  text += extractFormattedText(content);

  navigator.clipboard.writeText(text).then(function() {
    const btn = document.getElementById('copy-text-btn');
    const label = btn.querySelector('.copy-text-label');
    const originalText = label.textContent;
    label.textContent = '{{ if eq .Language.Lang "fr" }}Copi√© !{{ else }}Copied!{{ end }}';
    btn.classList.add('copied');

    setTimeout(function() {
      label.textContent = originalText;
      btn.classList.remove('copied');
    }, 2000);
  }).catch(function(err) {
    console.error('Failed to copy text: ', err);
    alert('{{ if eq .Language.Lang "fr" }}Erreur lors de la copie{{ else }}Failed to copy{{ end }}');
  });
});
</script>
{{ end }}
{{ end }}

